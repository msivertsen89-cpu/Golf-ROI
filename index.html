<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Golf ROI ‚Äì Treningsanalyse</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:16px;
  max-width:1000px;
  margin:auto;
}
h1 { margin-top:10px; }

.card {
  background:white;
  padding:14px;
  margin-bottom:14px;
  border-radius:8px;
}

button {
  padding:6px 10px;
  margin:4px 4px 0 0;
  cursor:pointer;
}

.accordion-header {
  font-weight:bold;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.accordion-content {
  display:none;
  margin-top:12px;
}

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
  gap:12px;
}
.field label { font-size:13px; }
.field .hint { font-size:12px; color:#777; }

input[type=number], select {
  width:100%;
  padding:6px;
}

.good { color:green; }
.bad { color:#c62828; }
.focus { color:#ef6c00; font-weight:bold; }

.tip {
  background:#f1f8e9;
  padding:10px;
  border-radius:6px;
  margin-top:8px;
}

.small { font-size:13px; color:#555; }

.diff-up { color:green; }
.diff-down { color:#c62828; }

.save-msg {
  color:green;
  font-size:13px;
  margin-top:6px;
}

/* MODALS */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal {
  background:white;
  padding:20px;
  border-radius:8px;
  max-width:520px;
  width:100%;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
}
/* Mobil: prioriter handlingar */
@media (max-width: 640px){
  .club-actions{
    order: -1;
    margin-bottom: 10px;
  }
}
/* =====================
   C2.2 ‚Äì Mobil: st√∏rre knappar
===================== */
@media (max-width: 640px){
  button{
    padding: 10px 14px;
    font-size: 15px;
  }
}
/* =====================
   C2.4 ‚Äì Fokus i open k√∏lle
===================== */
.club-focus{
  margin-top:10px;
  padding:10px;
  border-radius:6px;
  background:#fff8e1;
  border-left:4px solid #ffb300;
}

.club-focus strong{
  display:block;
  margin-bottom:4px;
}
.club-focus em{
  color:#555;
  font-style:italic;
}

</style>
</head>

<body>

<h1>üèåÔ∏è Golf ROI ‚Äì Treningsanalyse</h1>

<div class="card">
  <button onclick="openOnboarding()">üöÄ Kom i gang</button>
  <button onclick="openProfile()">‚öôÔ∏è Profil</button>
  <button onclick="openClubs()">üèåÔ∏è K√∏ller</button>
</div>

<!-- üü¢ Samla fokus basert p√• baseline -->
<div id="bagFocusCard" class="card" style="display:none;"></div>

<!-- Analyse per k√∏lle -->
<div id="clubs"></div>

<!-- ONBOARDING -->
<div class="overlay" id="onboarding">
  <div class="modal">
    <h3>üöÄ Kom i gang</h3>
    <ol>
      <li>Vel k√∏llene du brukar</li>
      <li>Legg inn gjennomsnittsdata</li>
      <li>Lagre baseline</li>
      <li>F√∏lg utvikling over tid</li>
    </ol>
    <button onclick="closeOnboarding()">Lukk</button>
  </div>
</div>

<!-- PROFIL -->
<div class="overlay" id="profile">
  <div class="modal">
    <h3>‚öôÔ∏è Profil</h3>

    <label>Handicap-niv√•</label>
    <select id="hcp">
      <option>0‚Äì8</option>
      <option>9‚Äì15</option>
      <option>16‚Äì29</option>
      <option>30‚Äì54</option>
    </select>

    <label>Prim√¶rt treningsfokus</label>
    <select id="preference">
      <option>Presisjon</option>
      <option>Lengde</option>
      <option>Balanse</option>
    </select>

    <br><br>
    <button onclick="saveProfile()">üíæ Lagre profil</button>
    <button onclick="closeProfile()">Lukk</button>
  </div>
</div>

<!-- K√òLLEVAL -->
<div class="overlay" id="clubsModal">
  <div class="modal">
    <h3>üèåÔ∏è Vel k√∏ller</h3>
    <div id="clubCheckboxes"></div>
    <button onclick="saveClubs()">üíæ Lagre</button>
    <button onclick="closeClubs()">Lukk</button>
  </div>
</div>

<!-- SESSIONS MODAL -->
<div class="overlay" id="sessionsModal">
  <div class="modal">
    <h3 id="sessionsTitle">üìö √òkter</h3>
    <div id="sessionsList"></div>
    <button onclick="closeSessions()">Lukk</button>
  </div>
</div>

<script>
/* ===================== KONFIG ===================== */

const STORAGE = "roi_state_v1_1";
const PROFILE = "roi_profile_v1_1";
const ACTIVE  = "roi_active_clubs_v1_1";

const ALL_CLUBS = [
  "Driver",
  "3W","5W","7W",
  "3H","4H","5H",
  "3i","4i","5i","6i","7i","8i","9i",
  "PW",
  "50¬∞",
  "56¬∞",
  "60¬∞"
];

const PGA = {
  wood:{ side:12, cons:12, smash:1.45 },
  iron:{ side:9, cons:8, smash:1.32 },
  wedge:{ side:7, cons:6, smash:1.22 }
};

/* ===================== COACHING-TEKSTAR (L√ÖST) ===================== */

const COACHING_TEXT = {

  Presisjon: {
    title: "Presisjon",
    short: "Startretning og sidekontroll er hovudutfordringa no.",
    long: `
Du taper slag fordi ballen startar for langt til h√∏gre eller venstre.

üéØ M√•l:
- Redusere side-consistency
- F√• fleire slag som startar n√¶r m√•l-linja

üîç Sj√• etter:
- Treffpunkt midt i slagflata
- Stabil oppstilling og sikte
- Lik startretning fr√• slag til slag
`
  },

  Lengdekontroll: {
    title: "Lengdekontroll",
    short: "Variasjon i lengde gjer k√∏lleval og innspel vanskeleg.",
    long: `
Du sl√•r b√•de for korte og for lange slag med same k√∏lle.

üéØ M√•l:
- Smalare lengdespredning
- Meir forutsigbar carry

üîç Sj√• etter:
- Stabilt tempo
- Lik ballposisjon
- Treff i same h√∏gde p√• slagflata
`
  },

  Treffkvalitet: {
    title: "Treffkvalitet",
    short: "Smash factor indikerer ustabil ballkontakt.",
    long: `
Du mistar fart og kontroll fordi du ikkje treff ballen reint nok.

üéØ M√•l:
- Auke smash factor
- Treff oftare n√¶r senter av slagflata

üîç Sj√• etter:
- Kontaktpunkt (bruk gjerne spray/tape)
- Rolig overgang i nedsving
- Balanse gjennom treff
`
  },

  Vedlikehald: {
    title: "Vedlikehald",
    short: "Dette fungerer bra ‚Äì hald ved like gode vanar.",
    long: `
Dataene viser at dette omr√•det fungerer godt no.

üéØ M√•l:
- Behalde niv√•et
- Unng√• regresjon

üîç Sj√• etter:
- Same rutinar
- Samme fokus som tidlegare
- Unng√• √• endre for mykje
`
  }

};

function clubType(c){
  if(c==="Driver"||c.includes("W")) return "wood";
  if(c.endsWith("i")) return "iron";
  return "wedge";
}

function drillLink(f){
  if(f==="Presisjon") return "ovelser/startretning.html";
  if(f==="Lengdekontroll") return "ovelser/lengdekontroll.html";
  if(f==="Treff") return "ovelser/treffkvalitet.html";
  if(f==="Vedlikehald") return "ovelser/vedlikehald.html";
  return "ovelser/driver-kontroll.html";
}

/* ===================== STATE ===================== */

let state = JSON.parse(localStorage.getItem(STORAGE)) || {};
let active = JSON.parse(localStorage.getItem(ACTIVE)) || [];

/* =====================
   v2.3 ‚Äì DATAMODELL
   Initialiser √∏kter trygt
===================== */

function initSessionModel(){
  if(typeof state !== "object") return;

  Object.keys(state).forEach(clubId => {
    const club = state[clubId];

    // Sikre baseline-struktur
    if(club.baseline && !club.baseline.date){
      club.baseline.date = new Date().toISOString().slice(0,10);
    }

    // Legg til sessions-array om den manglar
    if(!Array.isArray(club.sessions)){
      club.sessions = [];
    }

    // Sikre current eksisterer
    if(!club.current){
      club.current = {};
    }
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));
}

/* ===================== TREND HELPERS ===================== */

function trend(current, reference, higherIsBetter){
  const diff = current - reference;
  const good = higherIsBetter ? diff >= 0 : diff <= 0;
  const arrow = diff > 0 ? "‚Üë" : diff < 0 ? "‚Üì" : "‚Üí";
  const cls = good ? "diff-up" : "diff-down";
  return `<span class="${cls}">${arrow} ${Math.abs(diff).toFixed(2)}</span>`;
}

/* =====================
   v2.2 ‚Äì STEG 4: UI-RENDER
===================== */

function renderBagFocus(){
  const card = document.getElementById("bagFocusCard");
  if(!card) return;

  const result = getBagFocus();

  // Fallback: ikkje nok data
  if(!result || result.clubsCount < 3){
    card.style.display = "none";
    return;
  }

  const focus = result.focus;
  const text = COACHING_TEXT[focus];

  if(!text){
    card.style.display = "none";
    return;
  }

  card.innerHTML = `
    <h3>üéØ Fokus for neste treningsbolk</h3>
    <p><strong>${text.title}</strong></p>
    <p class="small">${text.short}</p>
    <pre class="small">${text.long}</pre>
    <p class="small">
      Basert p√• ${result.clubsCount} k√∏ller med baseline.
    </p>
  `;

  card.style.display = "block";
}

/* ===================== RENDER ===================== */

const wrap = document.getElementById("clubs");

function render(){
  wrap.innerHTML = "";

  const activeClubs = getActiveClubsSafe();

  if(!activeClubs.length){
    wrap.innerHTML = `
      <div class="card small">
        Ingen k√∏ller vald. Trykk p√• <strong>üèåÔ∏è K√∏ller</strong> for √• velje.
      </div>
    `;
    return;
  }

  activeClubs.forEach(c => {
    // S√∏rg for at state-struktur alltid finst
    if(!state[c]){
      state[c] = { current:{}, baseline:null, sessions:[] };
    }
    if(!state[c].sessions){
      state[c].sessions = [];
    }

    wrap.innerHTML += `
      <div class="card">
        <div class="accordion-header" onclick="toggle('${c}')">
          ${c}
          <span id="icon-${c}">‚ñ∂</span>
        </div>

        <div class="accordion-content" id="content-${c}">
          <div class="grid">
            ${field(c,"side","Side-consistency (m)","Side-til-side utslag")}
            ${field(c,"cons","Length consistency (m)","Lengdespredning")}
            ${field(c,"smash","Smash factor","Treffkvalitet",0.01)}
          </div>

          <div id="save-${c}"></div>
          <div id="eval-${c}"></div>
        </div>
      </div>
    `;

    renderSaveButtons(c);
    evaluate(c);
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));
}
renderBagFocus();

function field(c,k,l,h,s=1){
  const v = state[c].current[k] ?? "";
  return `
    <div class="field">
      <label>${l}</label>
      <div class="hint">${h}</div>
      <input
        type="number"
        name="${k}"
        step="${s}"
        value="${v}"
        oninput="update('${c}','${k}',this.value)">
    </div>
   `;
}
function renderSaveButtons(c){
  const el = document.getElementById("save-"+c);
  if(!el) return;

  const s = state[c];

  if(!s.baseline){
    el.innerHTML = `
      <button onclick="setBaseline('${c}')">üìå Lagre baseline</button>
    `;
  } else {
    const count = Array.isArray(s.sessions) ? s.sessions.length : 0;
    el.innerHTML = `
      <p class="small">Baseline lagra ‚úÖ</p>
      <button onclick="saveSession('${c}')">‚ûï Legg til √∏kt (${count})</button>
      <button onclick="editBaseline('${c}')">‚úèÔ∏è Rediger baseline</button>
    `;
  }
}

function update(c,k,v){
  state[c].current[k] = v ? parseFloat(v) : undefined;
  localStorage.setItem(STORAGE, JSON.stringify(state));
  evaluate(c);
  renderClubFocus(c);
}

function baselineButtons(c){
  const sessionsCount = state[c].sessions?.length || 0;

  if(!state[c].baseline){
    return `
      <button onclick="setBaseline('${c}')">üìå Lagre baseline</button>
    `;
  }

  return `
  <p class="small">Baseline lagra ‚úÖ</p>
  <button onclick="saveSession('${c}')">‚ûï Legg til √∏kt</button>
  <button onclick="openSessions('${c}')">üìö √òkter (${sessionsCount})</button>
  <button onclick="editBaseline('${c}')">‚úèÔ∏è Rediger baseline</button>
`;
}

function setBaseline(c){
  state[c].baseline = {...state[c].current};
  localStorage.setItem(STORAGE, JSON.stringify(state));
  showSaveMsg(c,"‚úì Baseline lagra");
  evaluate(c);
  renderBagFocus();
}

function saveSession(c){
  const success = addSession(c);

  if(success){
    const sessions = state[c].sessions;
    if(sessions && sessions.length){
      state[c].previous = { ...sessions[sessions.length - 1].data };
    }

    localStorage.setItem(STORAGE, JSON.stringify(state));
    showSaveMsg(c,"‚úì √òkt lagra");

    // üîÅ Oppdater knappane (√òkter n)
    document.getElementById(`buttons-${c}`).innerHTML = baselineButtons(c);

    // üßπ T√òM INPUT ETTER LAGRA √òKT  ‚Üê HER
    state[c].current = {};
    localStorage.setItem(STORAGE, JSON.stringify(state));

    ["side","cons","smash"].forEach(k => {
      const input = document.querySelector(
        `#content-${c} input[name="${k}"]`
      );
      if(input) input.value = "";
    });

    renderBagFocus();
  } else {
    showSaveMsg(c,"‚ö† Fyll inn minst to felt");
  }
  renderClubFocus(c);
}


function editBaseline(c){
  if(confirm("Slette baseline?")){
    state[c].baseline = null;
    localStorage.setItem(STORAGE, JSON.stringify(state));
    render();
  }
}

function showSaveMsg(c, text){
  const el = document.getElementById(`save-msg-${c}`);
  if(!el) return;

  el.textContent = text;
  el.style.display = "block";

  setTimeout(() => {
    el.textContent = "";
    el.style.display = "none";
  }, 2000);
}

function toggle(c){
  const e=document.getElementById("content-"+c);
  const i=document.getElementById("icon-"+c);
  e.style.display=e.style.display==="block"?"none":"block";
  i.textContent=e.style.display==="block"?"‚ñº":"‚ñ∂";
}

/* ===================== ANALYSE ===================== */

function evaluate(c){
  const v = state[c].current;
  const b = state[c].baseline;
  const p = PGA[clubType(c)];
  let good=[], bad=[], focus="Vedlikehald";

  if(v.side!=null){
    v.side<=p.side ? good.push("God sidekontroll") : bad.push("For stort sideutslag");
  }
  if(v.cons!=null){
    v.cons<=p.cons ? good.push("Stabil lengde") : bad.push("Ustabil lengde");
  }
  if(v.smash!=null){
    v.smash>=p.smash ? good.push("Reint treff") : bad.push("Ureint treff");
  }

  if(bad.includes("For stort sideutslag")) focus="Presisjon";
  else if(bad.includes("Ustabil lengde")) focus="Lengdekontroll";
  else if(bad.includes("Ureint treff")) focus="Treff";

  let trends = "";
  if(b){
    trends += `
      <strong>Trend mot baseline:</strong><br>
      Side: ${trend(v.side,b.side,false)}<br>
      Lengde: ${trend(v.cons,b.cons,false)}<br>
      Smash: ${trend(v.smash,b.smash,true)}<br>`;
  }
  if(state[c].previous){
    const p0 = state[c].previous;
    trends += `
      <br><strong>Sidan f√∏rre √∏kt:</strong><br>
      Side: ${trend(v.side,p0.side,false)}<br>
      Lengde: ${trend(v.cons,p0.cons,false)}<br>
      Smash: ${trend(v.smash,p0.smash,true)}<br>`;
  }

  document.getElementById("eval-"+c).innerHTML = `
    <p class="good"><strong>Bra:</strong> ${good.join(", ")||"‚Äî"}</p>
    <p class="bad"><strong>D√•rleg:</strong> ${bad.join(", ")||"‚Äî"}</p>
    <p class="focus">üéØ Fokus: ${focus}</p>
    ${trends ? `<div class="small">${trends}</div>` : ""}
    ${trendVsPrevious(c)}
    <div class="tip">
      <strong>üõ† Treningsforslag:</strong><br>
      <a href="${drillLink(focus)}" target="_blank">üëâ Opne √∏ving</a>
    </div>`;
    let highlight = "";

    if(focus === "Presisjon") highlight = "Side-consistency er hovudutfordringa.";
    if(focus === "Lengdekontroll") highlight = "Lengdespredning er hovudutfordringa.";
    if(focus === "Treff") highlight = "Treffkvalitet er hovudutfordringa.";
    if(focus === "Vedlikehald") highlight = "Ingen kritiske avvik.";
}

function renderClubFocus(c){
  const el = document.getElementById(`focus-${c}`);
  if(!el) return;

  const v = state[c]?.current;
  if(!v) return;

  const type = clubType(c);
  const p = PGA[type];

  let focus = "Vedlikehald";
  let reason = "Gode og stabile tal.";

  if(v.side != null && v.side > p.side){
    focus = "Presisjon";
    reason = "Side-consistency er over m√•lverdien.";
  } else if(v.cons != null && v.cons > p.cons){
    focus = "Lengdekontroll";
    reason = "Lengdespredning er for stor.";
  } else if(v.smash != null && v.smash < p.smash){
    focus = "Treff";
    reason = "Smash factor er under √∏nskja niv√•.";
  }

  el.innerHTML = `
    <strong>üéØ Fokus no:</strong>
    ${focus}<br>
    <span class="small">${reason}</span>
  `;
}

/* ===================== BAG-FOCUS (C1) ===================== */

function calculateBagFocus(){
  const activeClubs = getActiveClubsSafe();
  let counts = { Presisjon:0, Lengdekontroll:0, Treff:0 };
  let clubMap = { Presisjon:[], Lengdekontroll:[], Treff:[] };

  activeClubs.forEach(c => {
    if(!state[c] || !state[c].baseline || !state[c].current) return;

    const v = state[c].current;
    const b = state[c].baseline;
    const type = clubType(c);
    const p = PGA[type];

    if(v.side != null && b.side != null && v.side > b.side){
      counts.Presisjon++;
      clubMap.Presisjon.push(c);
      return;
    }

    if(v.cons != null && b.cons != null && v.cons > b.cons){
      counts.Lengdekontroll++;
      clubMap.Lengdekontroll.push(c);
      return;
    }

    if(v.smash != null && b.smash != null && v.smash < b.smash){
      counts.Treff++;
      clubMap.Treff.push(c);
      return;
    }
  });

  let topFocus = null;
  let max = 0;

  for(const f in counts){
    if(counts[f] > max){
      max = counts[f];
      topFocus = f;
    }
  }

  if(!topFocus || max === 0){
    return null;
  }

  return {
    focus: topFocus,
    count: max,
    clubs: clubMap[topFocus]
  };
}

function renderBagFocus(){
  const card = document.getElementById("bagFocusCard");
  const result = calculateBagFocus();

  if(!result){
    card.style.display = "none";
    return;
  }

  card.style.display = "block";
  card.innerHTML = `
    <h3>üéØ Hovudfokus no: ${result.focus}</h3>
    <p class="small">
      Basert p√• ${result.count} k√∏ller med avvik fr√• baseline
    </p>
    <p>
      üëâ Mest p√•verka: <strong>${result.clubs.join(", ")}</strong>
    </p>
  `;
}

function trendVsPrevious(c){
  const prev = state[c].previous;
  const curr = state[c].current;

  if(!prev || !curr) return "";

  const rules = {
    side:  "lower",
    cons:  "lower",
    smash: "higher"
  };

  let rows = [];

  Object.keys(rules).forEach(k => {
    if(curr[k] != null && prev[k] != null){
      const diff = curr[k] - prev[k];
      const better =
        (rules[k] === "lower"  && diff < 0) ||
        (rules[k] === "higher" && diff > 0);

      rows.push(`
        <div class="${better ? "diff-up" : "diff-down"}">
          ${k}: ${prev[k]} ‚Üí ${curr[k]}
          ${better ? "‚ñ≤" : "‚ñº"}
        </div>
      `);
    }
  });

  if(!rows.length) return "";

  return `
    <div class="small" style="margin-top:6px;">
      <strong>Trend mot f√∏rre √∏kt:</strong>
      ${rows.join("")}
    </div>
  `;
}

/* ===================== MODALS ===================== */

function openOnboarding(){document.getElementById("onboarding").style.display="flex";}
function closeOnboarding(){document.getElementById("onboarding").style.display="none";}
function openProfile(){document.getElementById("profile").style.display="flex";}
function closeProfile(){document.getElementById("profile").style.display="none";}
function openClubs(){
  document.getElementById("clubsModal").style.display="flex";
  const c=document.getElementById("clubCheckboxes");
  c.innerHTML="";
  ALL_CLUBS.forEach(k=>{
    c.innerHTML+=`
      <label>
        <input type="checkbox" ${active.includes(k)?"checked":""}
        onchange="toggleClub('${k}')"> ${k}
      </label>`;
  });
}
function closeClubs(){document.getElementById("clubsModal").style.display="none";}

function toggleClub(k){
  active = active.includes(k)
    ? active.filter(x => x !== k)
    : [...active, k];
}

function saveClubs(){
  localStorage.setItem(ACTIVE, JSON.stringify(active));
  closeClubs();
  render();
}

function saveProfile(){
  localStorage.setItem(PROFILE, JSON.stringify({
    hcp:document.getElementById("hcp").value,
    preference:document.getElementById("preference").value
  }));
  closeProfile();
}

/* =====================
   v2.3 ‚Äì √òkter (modal)
===================== */

function openSessions(c){
  const modal = document.getElementById("sessionsModal");
  const title = document.getElementById("sessionsTitle");
  const list  = document.getElementById("sessionsList");

  if(!modal || !state[c]) return;

  title.textContent = `üìö √òkter ‚Äì ${c}`;
  list.innerHTML = "";

  const sessions = state[c].sessions || [];

  if(!sessions.length){
    list.innerHTML = "<p class='small'>Ingen √∏kter lagra enno.</p>";
  } else {
    sessions.forEach(s => {
      list.innerHTML += `
        <div class="small">
          √òkt ${s.id} ‚Äì ${s.date}
        </div>
      `;
    });
  }

  modal.style.display = "flex";
}

function closeSessions(){
  const modal = document.getElementById("sessionsModal");
  if(modal) modal.style.display = "none";
}

/* INIT */
initSessionModel();

/* =====================
   v2.3 ‚Äì LEGG TIL √òKT
   Kun logikk (ingen UI)
===================== */

function canSaveSession(clubId){
  const club = state[clubId];
  if(!club || !club.current) return false;

  // Krev minst 2 utfylte parameterar
  const filled = ["side","cons","smash"].filter(
    k => club.current[k] != null
  );

  return filled.length >= 2;
}

function addSession(clubId){
  const club = state[clubId];
  if(!club) return false;

  if(!Array.isArray(club.sessions)){
    club.sessions = [];
  }

  if(!canSaveSession(clubId)){
    return false;
  }

  const nextId = club.sessions.length + 1;

  club.sessions.push({
    id: nextId,
    date: new Date().toISOString().slice(0,10),
    data: { ...club.current }
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));
  return true;
}

render();
renderBagFocus();

// =====================
// v2.2 ‚Äì STEG 1 (SAFE)
// =====================

function getActiveClubsSafe(){
  const stored = JSON.parse(localStorage.getItem(ACTIVE)) || [];

  // Returner aktive k√∏ller i autoritativ rekkef√∏lgje
  return ALL_CLUBS.filter(club => stored.includes(club));
}


function getClubsWithBaseline(){
  const active = getActiveClubsSafe();
  if(!Array.isArray(active)) return [];

  return active.filter(id =>
    state &&
    state[id] &&
    state[id].baseline
  );
}

function getClubFocus(clubId){
  if(!state || !state[clubId] || !state[clubId].current) return null;

  const v = state[clubId].current;
  const p = PGA[clubType(clubId)];
  if(!p) return null;

  if(v.side != null && v.side > p.side) return "Presisjon";
  if(v.cons != null && v.cons > p.cons) return "Lengdekontroll";
  if(v.smash != null && v.smash < p.smash) return "Treffkvalitet";

  return "Vedlikehald";
}
/* ==========================================
   v2.2 ‚Äì STEG 2: AGGREGERT BAG-FOKUS
========================================== */

function getBagFocus(){
  const clubs = getClubsWithBaseline();
  if(!clubs.length) return null;

  const counts = {};

  clubs.forEach(clubId => {
    const focus = getClubFocus(clubId);
    if(!focus) return;
    counts[focus] = (counts[focus] || 0) + 1;
  });

  let topFocus = null;
  let maxCount = 0;

  for(const f in counts){
    if(counts[f] > maxCount){
      maxCount = counts[f];
      topFocus = f;
    }
  }

  return {
    focus: topFocus,
    breakdown: counts,
    clubsCount: clubs.length
  };
}
</script>

</body>
</html>
