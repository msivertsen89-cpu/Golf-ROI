<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<title>Golf ROI â€“ Treningsanalyse</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:16px;
  max-width:1000px;
  margin:auto;
}
h1 { margin-top:10px; }

.card {
  background:white;
  padding:14px;
  margin-bottom:14px;
  border-radius:8px;
}

button {
  padding:6px 10px;
  margin:4px 4px 0 0;
  cursor:pointer;
}

.accordion-header {
  font-weight:bold;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.accordion-content {
  display:none;
  margin-top:12px;
}

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
  gap:12px;
}
.field label { font-size:13px; }
.field .hint { font-size:12px; color:#777; }

input[type=number], input[type=date], select {
  width:100%;
  padding:6px;
}

.good { color:green; }
.bad { color:#c62828; }
.focus { color:#ef6c00; font-weight:bold; }

.tip {
  background:#f1f8e9;
  padding:10px;
  border-radius:6px;
  margin-top:8px;
}

.small { font-size:13px; color:#555; }

.diff-up { color:green; }
.diff-down { color:#c62828; }

/* MODALS */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal {
  background:white;
  padding:20px;
  border-radius:8px;
  max-width:520px;
  width:100%;
}

canvas {
  width:100%;
  background:#fafafa;
  border:1px solid #ddd;
  border-radius:4px;
}

.report-root {
  font-size: 13px;
  color: #000;
}

.report-root h2,
.report-root h3 {
  page-break-after: avoid;
}

.report-section {
  margin-bottom: 16px;
  page-break-inside: avoid;
}

.report-divider {
  margin: 12px 0;
  border-top: 1px solid #ccc;
}

.page-break {
  height: 0;
  overflow: hidden;
  page-break-before: always;
  break-before: page;
}

@media print {

  /* ====== GRUNNINNSTILLING ====== */
  html, body {
    background: white !important;
    margin: 0;
    padding: 0;
  }

  body {
    font-size: 13px;
    color: #000;
  }

  /* ====== SKJUL ALT SOM IKKJE ER RAPPORT ====== */
  body > * {
    display: none !important;
  }

  /* ====== VIS RAPPORTEN ====== */
  #reportModal,
  #reportModal * {
    display: block !important;
  }

  /* Fjern modal-oppleving */
  .overlay {
    position: static !important;
    background: none !important;
  }

  .modal {
    position: static !important;
    max-width: none !important;
    max-height: none !important;
    overflow: visible !important;
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  /* ====== RAPPORT-LAYOUT ====== */
  .report-root {
    padding: 0;
  }

  .report-section {
    margin-bottom: 18px;
    page-break-inside: avoid;
  }

  .report-divider {
    border-top: 1px solid #ccc;
    margin: 14px 0;
  }

  h2, h3 {
    page-break-after: avoid;
    break-after: avoid;
  }

  /* ====== LISTAR OG TEKST ====== */
  ul {
    padding-left: 18px;
  }

  li {
    margin-bottom: 4px;
  }

  /* ====== SIDEOPPSETT ====== */
  @page {
    margin: 20mm;
  }
}

</style>
</head>

<body>

<h1>ğŸŒï¸ Golf ROI â€“ Treningsanalyse</h1>

<div class="card">
  <button onclick="openOnboarding()">ğŸš€ Kom i gang</button>
  <button onclick="openProfile()">âš™ï¸ Profil</button>
  <button onclick="openClubs()">ğŸŒï¸ KÃ¸ller</button>
  <button onclick="resetAllData()">â™»ï¸ Nullstill alt</button>
  <button onclick="openExplanation()">â„¹ï¸ Slik vurderer vi dataene</button>
  <button onclick="openReportClubModal()">ğŸ“„ Rapport</button>
</div>

<div id="bagFocusCard" class="card" style="display:none;"></div>

<div id="clubs"></div>

<!-- ONBOARDING -->
<div class="overlay" id="onboarding">
  <div class="modal">
    <h3>ğŸš€ Kom i gang</h3>
    <ol>
      <li>Vel kÃ¸ller</li>
      <li>Legg inn baseline</li>
      <li>Legg til Ã¸kter</li>
      <li>FÃ¸lg utvikling</li>
    </ol>
    <button onclick="closeOnboarding()">Lukk</button>
  </div>
</div>

<!-- PROFIL -->
<div class="overlay" id="profile">
  <div class="modal">
    <h3>âš™ï¸ Profil</h3>
    <label>Handicap</label>
    <select id="hcp">
      <option>0â€“8</option>
      <option>9â€“15</option>
      <option>16â€“29</option>
      <option>30â€“54</option>
    </select>
    <br><br>
    <button onclick="closeProfile()">Lukk</button>
  </div>
</div>

<!-- KÃ˜LLEVAL -->
<div class="overlay" id="clubsModal">
  <div class="modal">
    <h3>ğŸŒï¸ Vel kÃ¸ller</h3>
    <div id="clubCheckboxes"></div>
    <button onclick="saveClubs()">Lagre</button>
    <button onclick="closeClubs()">Lukk</button>
  </div>
</div>

<script>

/* =========================================================
   Golf ROI â€“ Treningsanalyse
   ---------------------------------------------------------
   Versjon: v2.6 (LOCKED)
   Status : Stabil, rydda state-modell og grafarkitektur

   HOVUDPRINSIPP:
   1. Ã‰in autoritativ state (state + active)
   2. render() er alltid sanningskjelde for UI
   3. All lagring gÃ¥r via persistAndUpdate()
   4. Graf oppdaterer seg kun nÃ¥r open (ingen skjult state)
   5. Kvar kÃ¸lle er isolert (ingen side-effektar)

   STATE-MODELL (per kÃ¸lle):
   state[club] = {
     baseline: { side, cons, smash } | null
     sessions: [
       { date, data:{ side, cons, smash } }
     ],
     current: { side?, cons?, smash? }
     _graphParam: "side" | "cons" | "smash"
   }

   VIKTIG:
   - Ikkje muter DOM direkte utanom render()
   - Ikkje skriv til localStorage utan persistAndUpdate()
   - Nye features skal leggast OPPÃ… denne strukturen,
     ikkje rundt eller utanfor.

   Denne fila er referansepunkt for vidare utvikling.
========================================================= */


/* =====================
   KONFIG / STATE
===================== */

const STORAGE = "roi_state_v2_6";
const ACTIVE  = "roi_active_v2_6";

const ALL_CLUBS = [
  "Driver",

  "3W","5W","7W",

  "3H","4H","5H",

  "3i","4i","5i","6i","7i","8i","9i",

  "PW",

  "50Â°","56Â°","60Â°"
];


const PGA = {
  wood:  { side:12, cons:12, smash:1.45 },
  iron:  { side:9,  cons:8,  smash:1.32 },
  wedge: { side:7,  cons:6,  smash:1.22 }
};

const COACHING_TEXT = {
    Presisjon: {
      title: "Presisjon",
      short: "Startretning og sidekontroll er hovudutfordringa no.",
      long: `
  Du taper slag fordi ballen startar for langt til hÃ¸gre eller venstre.

  ğŸ¯ Fokus:
  - Redusere side-consistency
  - Stabil startretning

  ğŸ” Jobb med:
  - Treffpunkt i slagflata
  - Sikte og oppstilling
  `
    },

    Lengdekontroll: {
      title: "Lengdekontroll",
      short: "Variasjon i lengde gjer kÃ¸lleval vanskeleg.",
      long: `
  Lengdespredninga er for stor til Ã¥ vere pÃ¥liteleg.

  ğŸ¯ Fokus:
  - Jamn carry-lengde
  - Stabil tempo

  ğŸ” Jobb med:
  - Lik ballposisjon
  - Samme svinglengde
  `
    },

    Treff: {
      title: "Treffkvalitet",
      short: "Smash factor indikerer ustabil ballkontakt.",
      long: `
  Du mistar fart og kontroll fordi treffet ikkje er reint nok.

  ğŸ¯ Fokus:
  - Auke smash factor
  - Treff nÃ¦r sentrum

  ğŸ” Jobb med:
  - Balanse gjennom treff
  - Rolig overgang
  `
    }
};

function clubType(c){
  if(c==="Driver") return "wood";
  if(c.endsWith("i")) return "iron";
  return "wedge";
}

function drillLink(focus){
  if(focus === "Presisjon") return "ovelser/startretning.html";
  if(focus === "Lengdekontroll") return "ovelser/lengdekontroll.html";
  if(focus === "Treff") return "ovelser/treffkvalitet.html";
  return "ovelser/vedlikehald.html";
}

let state = JSON.parse(localStorage.getItem(STORAGE)) || {};
let active = JSON.parse(localStorage.getItem(ACTIVE)) || [];

let openClubId = null;
let selectedSessionClub = null;
let selectedSessionIndex = null;
let selectedReportClubs = [];

/* =====================
   INIT STATE (SAFE)
===================== */
function ensureClub(c){
  // Sikrar at kvar kÃ¸lle alltid har korrekt og komplett struktur
  // Denne funksjonen SKAL vere idempotent (trygg Ã¥ kÃ¸yre fleire gonger)
  if(!state[c]){
    state[c] = {
      baseline: null,        // Fast referanse (brukar-sett)
      sessions: [],          // Historiske Ã¸kter (autoritative)
      current: {},           // Midlertidig input fÃ¸r lagring
      _graphParam: "side"    // Aktiv graf-parameter
    };
  }
}

/* =====================
   RENDER
===================== */
const wrap = document.getElementById("clubs");

// =========================================================
// RENDER-PIPELINE (AUTORITATIV)
// ---------------------------------------------------------
// - Bygger ALT UI frÃ¥ state
// - Skal kallast etter kvar endring i data
// - Ingen andre funksjonar skal manipulere UI direkte
// =========================================================

function render(){
  wrap.innerHTML = "";

  if(!active.length){
    wrap.innerHTML = `<div class="card small">Vel kÃ¸ller for Ã¥ starte.</div>`;
    return;
  }

  ALL_CLUBS.filter(c => active.includes(c)).forEach(c=>{
    ensureClub(c);

    wrap.innerHTML += `
      <div class="card">
        <div class="accordion-header" onclick="toggle('${c}')">
          ${c}
          <span id="icon-${c}">â–¶</span>
        </div>

        <div class="accordion-content" id="content-${c}">
          <div class="field" style="max-width:260px; margin-bottom:6px;">
              <label>Dato for Ã¸kt</label>
              <div class="hint">NÃ¥r Ã¸kta faktisk vart gjennomfÃ¸rt</div>
              <input type="date" id="date-${c}" value="${today()}">
            </div>
          <div class="grid">
            ${field(c,"side","Side-consistency (m)")}
            ${field(c,"cons","Length consistency (m)")}
            ${field(c,"smash","Smash factor",0.01)}
          </div>


          <div style="margin-top:8px">
            ${renderButtons(c)}
          </div>

          <div id="eval-${c}"></div>

          <button onclick="toggleGraph('${c}')">ğŸ“Š Vis graf</button>

          <div id="graph-${c}" style="display:none; margin-top:8px">
          <div class="small" style="margin-bottom:4px;">
             <strong>Utvikling over tid</strong><br>
            <em>BlÃ¥ linje = Ã¸kter Â· Stipla = baseline Â· GrÃ¥ = referanse</em>
          </div>

            <select onchange="changeGraphParam('${c}',this.value)">
              <option value="side">Side</option>
              <option value="cons">Lengde</option>
              <option value="smash">Smash</option>
            </select>

            <canvas id="canvas-${c}" width="360" height="160"></canvas>
            <div id="graphInsight-${c}" class="small"></div>
          </div>
        </div>
      </div>
    `;
    renderClubEvaluation(c);
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));
}
renderBagFocus();

function renderBagFocus(){
  const card = document.getElementById("bagFocusCard");
  if(!card) return;

  const result = calculateBagFocus();
  if(!result){
    card.style.display = "none";
    return;
  }

  const text = COACHING_TEXT[result.focus];
  if(!text){
    card.style.display = "none";
    return;
  }

  card.innerHTML = `
    <h3>ğŸ¯ Hovudfokus for treninga</h3>

    <p class="focus">${text.title}</p>
    <p class="small">${text.short}</p>

    <pre class="small">${text.long}</pre>

    <p class="small">
      Basert pÃ¥ ${result.count} kÃ¸ller:
      <strong>${result.clubs.join(", ")}</strong>
    </p>
  `;

  card.style.display = "block";
}

function field(c,k,label,step=1){
  const v = state[c].current[k] ?? "";
  return `
    <div class="field">
      <label>${label}</label>
      <input type="number" step="${step}"
        value="${v}"
        oninput="updateValue('${c}','${k}',this.value)">
    </div>
  `;
}

function evaluateClub(c){
  const club = state[c];
  if(!club) return null;

  const v =
    Object.keys(club.current).length
      ? club.current
      : club.sessions.length
        ? club.sessions[club.sessions.length - 1].data
        : null;

  if(!v) return null;

  const p = PGA[clubType(c)];
  const baseline = club.baseline;
  const prevSession =
    club.sessions.length > 1
      ? club.sessions[club.sessions.length - 2].data
      : null;

  let good=[], bad=[], focus="Vedlikehald";

  if(v.side!=null){
    v.side<=p.side ? good.push("God sidekontroll")
                   : bad.push("For stort sideutslag");
  }
  if(v.cons!=null){
    v.cons<=p.cons ? good.push("Stabil lengde")
                   : bad.push("Ustabil lengde");
  }
  if(v.smash!=null){
    v.smash>=p.smash ? good.push("Reint treff")
                     : bad.push("Ureint treff");
  }

  if(bad.includes("For stort sideutslag")) focus="Presisjon";
  else if(bad.includes("Ustabil lengde")) focus="Lengdekontroll";
  else if(bad.includes("Ureint treff")) focus="Treff";

  let trends = "";

  if(baseline){
    trends += `
      <div class="small">
        <strong>Trend mot baseline:</strong><br>
        Side: ${trendValue(v.side, baseline.side, true)}<br>
        Lengde: ${trendValue(v.cons, baseline.cons, true)}<br>
        Smash: ${trendValue(v.smash, baseline.smash, false)}
      </div>
    `;
  }

  if(prevSession){
    trends += `
      <div class="small" style="margin-top:4px;">
        <strong>Sidan fÃ¸rre Ã¸kt:</strong><br>
        Side: ${trendValue(v.side, prevSession.side, true)}<br>
        Lengde: ${trendValue(v.cons, prevSession.cons, true)}<br>
        Smash: ${trendValue(v.smash, prevSession.smash, false)}
      </div>
    `;
  }

  return {good,bad,focus,trends};

}

function renderButtons(c){
  const count = state[c].sessions.length;

  if(!state[c].baseline){
    return `
      <button onclick="setBaseline('${c}')">ğŸ“Œ Lagre baseline</button>
    `;
  }

  return `
    <button onclick="saveSession('${c}')">â• Legg til Ã¸kt</button>
    <button onclick="openSessions('${c}')">ğŸ“š Ã˜kter (${count})</button>
    <button onclick="editBaseline('${c}')">âœï¸ Rediger baseline</button>
    <button onclick="resetClub('${c}')">â™»ï¸ Nullstill kÃ¸lle</button>
  `;
}



function renderClubEvaluation(c){
  const el = document.getElementById(`eval-${c}`);
  if(!el) return;

  const r = evaluateClub(c);
  if(!r){
    el.innerHTML="";
    return;
  }

  const p = PGA[clubType(c)];

  el.innerHTML=`
    <p class="good"><strong>Bra:</strong> ${r.good.join(", ")||"â€”"}</p>
    <p class="bad"><strong>DÃ¥rleg:</strong> ${r.bad.join(", ")||"â€”"}</p>

    <p class="focus">ğŸ¯ Fokus: ${r.focus}</p>

    <div class="small" style="margin-top:4px;">
      <strong>ReferansenivÃ¥ (${clubType(c)}):</strong><br>
      Side â‰¤ ${p.side} m Â· Lengde â‰¤ ${p.cons} m Â· Smash â‰¥ ${p.smash}
    </div>

    ${r.trends || ""}

    <div class="tip">
      <strong>ğŸ›  Treningsforslag:</strong><br>
      <a href="${drillLink(r.focus)}" target="_blank">
        ğŸ‘‰ Opne Ã¸ving for ${r.focus.toLowerCase()}
      </a>
    </div>
  `;

}

function trendValue(current, reference, betterWhenLower){
  if(current == null || reference == null) return "â€”";

  const diff = current - reference;
  if(diff === 0) return "â†’ 0";

  const good = betterWhenLower ? diff < 0 : diff > 0;
  const arrow = diff > 0 ? "â†‘" : "â†“";
  const cls = good ? "diff-up" : "diff-down";

  return `<span class="${cls}">${arrow} ${Math.abs(diff).toFixed(2)}</span>`;
}

function openSessions(c){
  const sessions = state[c].sessions;
  if(!sessions.length){
    alert("Ingen Ã¸kter lagra enno.");
    return;
  }

  const list = sessions
    .map((s,i)=>`Ã˜kt ${i+1}: ${s.date}`)
    .join("\n");

  alert(`Ã˜kter for ${c}:\n\n${list}`);
}

function editBaseline(c){
  if(!confirm("Vil du slette baseline for denne kÃ¸lla?")){
    return;
  }

  state[c].baseline = null;
  localStorage.setItem(STORAGE, JSON.stringify(state));
  render();
}

/* =====================
   DATA-HANDLING
===================== */

function resetClub(c){
  if(!confirm(`Nullstille all data for ${c}?`)){
    return;
  }

  state[c].baseline = null;
  state[c].sessions = [];
  state[c].current = {};

  localStorage.setItem(STORAGE, JSON.stringify(state));

  openClubId = c;
  render();

  const content = document.getElementById("content-"+c);
  const icon = document.getElementById("icon-"+c);
  if(content && icon){
    content.style.display = "block";
    icon.textContent = "â–¼";
  }

  renderBagFocus();
}

function updateValue(c,k,v){
  state[c].current[k] = v ? parseFloat(v) : null;
}

function setBaseline(c){
  state[c].baseline = {...state[c].current};
  state[c].current = {};
  persistAndUpdate(c);
}

function saveSession(c){
  const cur = state[c].current;

  if(!cur.side && !cur.cons && !cur.smash){
    alert("Fyll minst eitt felt");
    return;
  }

  // ğŸ”‘ HENT DATO FRÃ… INPUT
  const dateInput = document.getElementById(`date-${c}`);
  const performedDate = dateInput?.value || today();

  state[c].sessions.push({
    date: performedDate,
    data: { ...cur }
  });

  state[c].current = {};
  persistAndUpdate(c);
}

// =========================================================
// EINASTE LOVLEGE VEI FOR DATA-ENDRING
// ---------------------------------------------------------
// 1. Lagrar state til localStorage
// 2. Re-render heile UI
// 3. Gjenopnar aktiv kÃ¸lle
// 4. Oppdaterer graf dersom open
// =========================================================

function persistAndUpdate(c){
  // ğŸ” Var grafen open fÃ¸r render?
  const graphWasOpen =
    document.getElementById(`graph-${c}`)?.style.display === "block";

  // ğŸ” Hugs open kÃ¸lle
  openClubId = c;

  // ğŸ’¾ Lagre state
  localStorage.setItem(STORAGE, JSON.stringify(state));

  // ğŸ”„ Re-render alt
  render();

  // ğŸ”“ Gjenopne kÃ¸lla
  const content = document.getElementById("content-"+openClubId);
  const icon = document.getElementById("icon-"+openClubId);
  if(content && icon){
    content.style.display = "block";
    icon.textContent = "â–¼";
  }

  // ğŸ“Š Gjenopne grafen om den var open
  if(graphWasOpen){
    const graphBox = document.getElementById(`graph-${c}`);
    if(graphBox){
      graphBox.style.display = "block";
      updateGraph(c);
    }
  }

  // ğŸ§  Oppdater analyse
  renderClubEvaluation(c);
}

/* =====================
   GRAF â€“ v2.6 (AUTORITATIV)
===================== */

function updateGraph(c){
  const box = document.getElementById(`graph-${c}`);
  if(!box || box.style.display!=="block") return;
  drawGraph(c, state[c]._graphParam);
}

function toggleGraph(c){
  const box = document.getElementById(`graph-${c}`);
  box.style.display = box.style.display==="block" ? "none" : "block";
  updateGraph(c);
}

function changeGraphParam(c,p){
  state[c]._graphParam = p;
  updateGraph(c);
}

function drawGraph(c,param){
  const canvas = document.getElementById(`canvas-${c}`);
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  const club = state[c];
  const baseline = club.baseline?.[param];

  const series = club.sessions
    .filter(s=>s.data[param]!=null)
    .map(s=>({date:s.date,value:s.data[param]}));

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!series.length){
    document.getElementById(`graphInsight-${c}`).innerHTML = "ğŸŸ  Ingen data enno";
    return;
  }

  const pad = 40;
  const w = canvas.width;
  const h = canvas.height;

  const values = series.map(d=>d.value);
  let min = Math.min(...values);
  let max = Math.max(...values);

  if(baseline != null){
    min = Math.min(min, baseline);
    max = Math.max(max, baseline);
  }

  if(min === max){ min -= 1; max += 1; }

  const xStep = (w - pad*2) / (series.length - 1 || 1);
  const yScale = (h - pad*2) / (max - min);

  const unit = (param === "side" || param === "cons") ? " m" : "";

  // === Y-akse ===
  ctx.font = "11px Arial";
  ctx.fillStyle = "#555";
  ctx.textAlign = "right";
  ctx.textBaseline = "middle";

  ctx.fillText(`${min.toFixed(1)}${unit}`, pad-6, h-pad);
  ctx.fillText(`${max.toFixed(1)}${unit}`, pad-6, pad);

  // === Baseline-linje ===
  if(baseline != null){
    const yBase = h - pad - (baseline - min) * yScale;
    ctx.beginPath();
    ctx.setLineDash([4,4]);
    ctx.strokeStyle = "#c62828";
    ctx.moveTo(pad, yBase);
    ctx.lineTo(w - pad, yBase);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // === ReferansenivÃ¥ (PGA) ===
  const ref = PGA[clubType(c)]?.[param];
  if(ref != null){
    const yRef = h - pad - (ref - min) * yScale;
    ctx.beginPath();
    ctx.setLineDash([2,4]);
    ctx.strokeStyle = "#999";
    ctx.moveTo(pad, yRef);
    ctx.lineTo(w - pad, yRef);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // === Graf-linje ===
  ctx.beginPath();
  ctx.strokeStyle = "#1976d2";
  ctx.lineWidth = 2;

  series.forEach((d,i)=>{
    const x = pad + i * xStep;
    const y = h - pad - (d.value - min) * yScale;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.stroke();

  // === Punkt ===
  ctx.fillStyle = "#1976d2";
  series.forEach((d,i)=>{
    const x = pad + i * xStep;
    const y = h - pad - (d.value - min) * yScale;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  // === X-akse datoar ===
  ctx.font = "11px Arial";
  ctx.fillStyle = "#555";
  ctx.textBaseline = "top";

  ctx.textAlign = "left";
  ctx.fillText(series[0].date, pad, h - pad + 4);

  ctx.textAlign = "right";
  ctx.fillText(series[series.length-1].date, w - pad, h - pad + 4);

  // === Innsikt ===
  const first = series[0].value;
  const last  = series[series.length-1].value;
  const diff  = last - first;

  let emoji = "ğŸŸ ";
  let text  = "Relativt stabil utvikling.";

  if(param === "smash"){
    if(diff > 0.01){ emoji="ğŸŸ¢"; text="Smash factor har betra seg."; }
    if(diff < -0.01){ emoji="ğŸ”´"; text="Smash factor har blitt svakare."; }
  } else {
    if(diff < -0.1){ emoji="ğŸŸ¢"; text="Kontrollen har blitt betre."; }
    if(diff >  0.1){ emoji="ğŸ”´"; text="Kontrollen har blitt svakare."; }
  }

  document.getElementById(`graphInsight-${c}`).innerHTML =
    `${emoji} ${text}`;
}

/* =====================
   UI HELPERS
===================== */
function toggle(c){
  const e=document.getElementById("content-"+c);
  const i=document.getElementById("icon-"+c);
  const open=e.style.display==="block";
  e.style.display=open?"none":"block";
  i.textContent=open?"â–¶":"â–¼";
  openClubId=open?null:c;
}

function today(){
  return new Date().toISOString().slice(0,10);
}

function safeId(str){
  return str.replace(/[^a-z0-9]/gi, "");
}

/* =====================
   MODALS / CLUBS
===================== */
function openOnboarding(){on("onboarding")}
function closeOnboarding(){off("onboarding")}
function openProfile(){on("profile")}
function closeProfile(){off("profile")}
function openClubs(){
  on("clubsModal");
  const box=document.getElementById("clubCheckboxes");
  box.innerHTML="";
  ALL_CLUBS.forEach(c=>{
    box.innerHTML+=`
      <label>
        <input type="checkbox" ${active.includes(c)?"checked":""}
          onchange="toggleClub('${c}')"> ${c}
      </label><br>
    `;
  });
}
function closeClubs(){off("clubsModal")}

function toggleClub(c){
  active = active.includes(c)
    ? active.filter(x=>x!==c)
    : [...active,c];
}

function saveClubs(){
  localStorage.setItem(ACTIVE, JSON.stringify(active));
  closeClubs();
  render();
}

function on(id){document.getElementById(id).style.display="flex"}
function off(id){document.getElementById(id).style.display="none"}

function openExplanation(){
  on("explanationModal");
}

function closeExplanation(){
  off("explanationModal");
}

function openReportClubModal(){
  const box = document.getElementById("reportClubList");
  selectedReportClubs = [];

  box.innerHTML = "";

  active.forEach(c=>{
    box.innerHTML += `
      <label>
        <input type="checkbox"
               onchange="toggleReportClub('${c}')">
        ${c}
      </label><br>
    `;
  });

  document.getElementById("reportClubModal").style.display = "flex";
}

function closeReportClubModal(){
  document.getElementById("reportClubModal").style.display = "none";
}

function closeReportPreview(){
  document.getElementById("reportModal").style.display = "none";
}

function toggleReportClub(c){
  selectedReportClubs = selectedReportClubs.includes(c)
    ? selectedReportClubs.filter(x=>x!==c)
    : [...selectedReportClubs, c];
}

function confirmReportClubs(){
  if(selectedReportClubs.length === 0){
    alert("Vel minst Ã©i kÃ¸lle fÃ¸r du lagar rapport.");
    return;
  }

  closeReportClubModal();
  openReportPreview(selectedReportClubs);
}

/* INIT */
render();

function calculateBagFocus(){
  let counts = {
    Presisjon: 0,
    Lengdekontroll: 0,
    Treff: 0
  };

  active.forEach(c=>{
    const r = evaluateClub(c);
    if(!r) return;

    if(r.focus === "Presisjon") counts.Presisjon++;
    if(r.focus === "Lengdekontroll") counts.Lengdekontroll++;
    if(r.focus === "Treff") counts.Treff++;
  });

  let top = null;
  let max = 0;

  Object.keys(counts).forEach(k=>{
    if(counts[k] > max){
      max = counts[k];
      top = k;
    }
  });

  if(!top || max === 0) return null;

  const clubs = [];

  active.forEach(c=>{
    const r = evaluateClub(c);
    if(r && r.focus === top){
      clubs.push(c);
    }
  });

  return { focus: top, count: max, clubs };

}

function buildReportData(clubsFilter){
  const generatedAt = new Date().toISOString().slice(0,10);
  const bagFocus = calculateBagFocus();

  const clubs = ALL_CLUBS
    .filter(c => clubsFilter.includes(c))
    .map(c => {
      const club = state[c];
      if(!club) return null;

      const evaluation = evaluateClub(c);

      return {
        club: c,
        type: clubType(c),
        baseline: club.baseline,
        sessionsCount: club.sessions.length,
        lastSession:
          club.sessions.length
            ? club.sessions[club.sessions.length - 1]
            : null,
        evaluation,
        graphs: {
          side: club.sessions.map(s => ({
            date: s.date,
            value: s.data.side
          })),
          cons: club.sessions.map(s => ({
            date: s.date,
            value: s.data.cons
          })),
          smash: club.sessions.map(s => ({
            date: s.date,
            value: s.data.smash
          }))
        }
      };
    })
    .filter(Boolean);

  return {
    meta: {
      generatedAt,
      reference: "PGA amatÃ¸r-nivÃ¥",
      clubsCount: clubs.length
    },
    bagFocus,
    clubs
  };
}

function openReportPreview(clubsFilter){
  const data = buildReportData(clubsFilter);
  const el = document.getElementById("reportContent");

  el.innerHTML = renderReportHTML(data);
  document.getElementById("reportModal").style.display = "flex";
}

/* =========================
   ğŸ–¨ï¸ PRINT (NY FUNKSJON)
========================= */
function printReport(clubsFilter){
  const data = buildReportData(clubsFilter);
  const root = document.getElementById("printRoot");

  root.innerHTML = renderReportHTML(data);
  root.style.display = "block";

  // Vent pÃ¥ DOM + canvas-render
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {

      drawReportGraphs(data);

      requestAnimationFrame(() => {
        window.print();

        // Rydd opp
        root.innerHTML = "";
        root.style.display = "none";
      });

    });
  });
}

function printReport(){
  window.print();
}

function renderReportHTML(data){
  let html = `
    <div class="report-section">
      <h2>ğŸ“„ Treningsoppsummering â€“ Golf ROI</h2>

      <p class="small">
        <strong>Periode:</strong> ${data.meta.generatedAt}<br>
        <strong>Referanse:</strong> ${data.meta.reference}
      </p>
    </div>
  `;

  /* =====================
     ğŸ¯ SAMANDRAG / HOVUDFOKUS
  ===================== */
  const focusKey = data.bagFocus?.focus;
  const coaching = COACHING_TEXT[focusKey];

  html += `
    <div class="report-section">
      <h3>ğŸ¯ Hovudfokus for treninga</h3>

      <p class="focus">
        ${coaching?.title || "Ingen klar hovudprioritet"}
      </p>

      ${
        coaching
          ? `
            <p class="small">${coaching.short}</p>
            <pre class="small">${coaching.long}</pre>
          `
          : `
            <p class="small">
              Ikkje nok data til Ã¥ gi ei tydeleg anbefaling.
            </p>
          `
      }

      <p class="small">
        Basert pÃ¥ ${data.bagFocus?.count || 0} kÃ¸ller:
        <strong>${(data.bagFocus?.clubs || []).join(", ")}</strong>
      </p>
    </div>

    <div class="report-divider"></div>
  `;

  /* =====================
     ğŸŒï¸ ANALYSE PER KÃ˜LLE
  ===================== */
  data.clubs.forEach(c => {
    const e = c.evaluation;

    html += `
      <div class="report-section">
        <h3>ğŸŒï¸ ${c.club}</h3>

        <p class="small">
          Ã˜kter i perioden: ${c.sessionsCount}
        </p>

        <p>
          <strong>Status:</strong>
          ${
            e?.bad?.length
              ? "<span class='bad'>Under baseline</span>"
              : "<span class='good'>PÃ¥ eller over baseline</span>"
          }
        </p>

        <p>
          <strong>PrimÃ¦rt treningsfokus:</strong>
          <span class="focus">${e?.focus || "Vedlikehald"}</span>
        </p>

        <div class="small">
          <strong>Bra:</strong> ${(e?.good || []).join(", ") || "â€”"}<br>
          <strong>DÃ¥rleg:</strong> ${(e?.bad || []).join(", ") || "â€”"}
        </div>

        <p class="small" style="margin-top:8px;">
          ${e?.focus === "Vedlikehald"
            ? "Denne kÃ¸lla fungerer stabilt og bÃ¸r vedlikehaldast."
            : "Denne kÃ¸lla bÃ¸r prioriterast i treninga."
          }
        </p>
      </div>
    `;
  });

  /* =====================
     ğŸ“ˆ TRENDOPPSUMMERING
  ===================== */
  html += `
    <div class="report-section">
      <h3>ğŸ“ˆ Trendoppsummering</h3>

      <p class="small">
        Denne vurderinga er basert pÃ¥ samanlikning mellom baseline
        og dei siste Ã¸ktene pÃ¥ tvers av kÃ¸ller.
      </p>

      <ul class="small">
        <li>Presisjon: vurdert per kÃ¸lle basert pÃ¥ side-consistency</li>
        <li>Lengdekontroll: vurdert per kÃ¸lle basert pÃ¥ lengdevariasjon</li>
        <li>Treffkvalitet: vurdert per kÃ¸lle basert pÃ¥ smash factor</li>
      </ul>

      <p class="small">
        Bruk trendane som rettesnor over fleire Ã¸kter,
        ikkje som fasit frÃ¥ ei enkelt Ã¸kt.
      </p>
    </div>
  `;

  /* =====================
     ğŸ›  TRENINGSPLAN
  ===================== */
  html += `
    <div class="report-section">
      <h3>ğŸ›  Anbefalt treningsplan</h3>

      <p class="small">
        FÃ¸lg planen i 2â€“3 Ã¸kter fÃ¸r ny evaluering.
      </p>

      <ul class="small">
        <li><strong>Ã˜kt 1:</strong> Hovudfokus â€“ ${coaching?.title || "valfritt fokus"}</li>
        <li><strong>Ã˜kt 2:</strong> Stabilisering av same fokus</li>
        <li><strong>Ã˜kt 3:</strong> Vedlikehald av kÃ¸ller som fungerer</li>
      </ul>
    </div>
  `;

  return html;
}

function drawReportGraphs(data){
  data.clubs.forEach(c => {

    const clubId = safeId(c.club);

    [
      { key: "side" },
      { key: "cons" },
      { key: "smash" }
    ].forEach(({ key }) => {

      const canvas = document.getElementById(`report-${clubId}-${key}`);
      if(!canvas) return;

      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const series = (c.graphs[key] || []).filter(d => d.value != null);
      if(series.length === 0) return;

      const baseline = c.baseline?.[key];

      const pad = 30;
      const w = canvas.width;
      const h = canvas.height;

      const values = series.map(d => d.value);
      if(baseline != null) values.push(baseline);

      let min = Math.min(...values);
      let max = Math.max(...values);
      if(min === max){ min -= 1; max += 1; }

      const xStep = (w - pad * 2) / (series.length - 1 || 1);
      const yScale = (h - pad * 2) / (max - min);

      // Baseline
      if(baseline != null){
        const yBase = h - pad - (baseline - min) * yScale;
        ctx.setLineDash([4,4]);
        ctx.strokeStyle = "#c62828";
        ctx.beginPath();
        ctx.moveTo(pad, yBase);
        ctx.lineTo(w - pad, yBase);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Line
      ctx.strokeStyle = "#1976d2";
      ctx.lineWidth = 2;
      ctx.beginPath();

      series.forEach((d,i)=>{
        const x = pad + i * xStep;
        const y = h - pad - (d.value - min) * yScale;
        i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });

      ctx.stroke();

      // Points
      ctx.fillStyle = "#1976d2";
      series.forEach((d,i)=>{
        const x = pad + i * xStep;
        const y = h - pad - (d.value - min) * yScale;
        ctx.beginPath();
        ctx.arc(x,y,3,0,Math.PI*2);
        ctx.fill();
      });

    });
  });
}

function drawMiniReportGraph(canvasId, series, baseline, param){
  const canvas = document.getElementById(canvasId);
  if(!canvas || !series.length) return;

  const ctx = canvas.getContext("2d");
  const pad = 30;
  const w = canvas.width;
  const h = canvas.height;

  ctx.clearRect(0,0,w,h);

  const values = series
    .map(d => d.value)
    .filter(v => v != null);

  if(baseline != null) values.push(baseline);
  if(!values.length) return;

  let min = Math.min(...values);
  let max = Math.max(...values);
  if(min === max){ min -= 1; max += 1; }

  const xStep = (w - pad*2) / (series.length - 1 || 1);
  const yScale = (h - pad*2) / (max - min);

  // Baseline
  if(baseline != null){
    const yBase = h - pad - (baseline - min) * yScale;
    ctx.setLineDash([4,4]);
    ctx.strokeStyle = "#c62828";
    ctx.beginPath();
    ctx.moveTo(pad, yBase);
    ctx.lineTo(w - pad, yBase);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Line
  ctx.strokeStyle = "#1976d2";
  ctx.lineWidth = 2;
  ctx.beginPath();

  series.forEach((d,i)=>{
    if(d.value == null) return;
    const x = pad + i * xStep;
    const y = h - pad - (d.value - min) * yScale;
    i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });

  ctx.stroke();
}

function openSessions(c){
  const modal = document.getElementById("sessionsModal");
  const title = document.getElementById("sessionsTitle");
  const list  = document.getElementById("sessionsList");

  title.textContent = `ğŸ“š Ã˜kter â€“ ${c}`;
  list.innerHTML = "";

  // âœ… SORTER ETTER DATO (IKKJE ENDRE STATE)
  const sessions = [...(state[c].sessions || [])]
    .sort((a, b) => a.date.localeCompare(b.date));

  if(!sessions.length){
    list.innerHTML = "<p class='small'>Ingen Ã¸kter lagra.</p>";
  } else {
    sessions.forEach((s, i)=>{
      list.innerHTML += `
        <div class="small" style="cursor:pointer"
             onclick="openSessionActions('${c}', ${i})">
          <strong>${s.date}</strong><br>
          Side: ${s.data.side ?? "â€”"},
          Lengde: ${s.data.cons ?? "â€”"},
          Smash: ${s.data.smash ?? "â€”"}
        </div>
      `;
    });
  }

  modal.style.display = "flex";
}

function closeSessions(){
  document.getElementById("sessionsModal").style.display = "none";
}

function openSessionActions(clubId, sessionIndex){
  selectedSessionClub = clubId;
  selectedSessionIndex = sessionIndex;

  // ğŸ”’ Lukk Ã¸kt-lista fÃ¸r ny modal
  closeSessions();

  const s = state[clubId].sessions[sessionIndex];
  document.getElementById("sessionActionsTitle").textContent =
    `Ã˜kt ${sessionIndex + 1} â€“ ${s.date}`;

  document.getElementById("sessionActionsModal").style.display = "flex";
}

function closeSessionActions(){
  document.getElementById("sessionActionsModal").style.display = "none";
  selectedSessionClub = null;
  selectedSessionIndex = null;
}
function confirmEditSession(){
  if(selectedSessionClub == null) return;

  const club = state[selectedSessionClub];
  const session = club.sessions[selectedSessionIndex];
  if(!session) return;

  // Last Ã¸kta inn i input
  club.current = { ...session.data };

  // Fjern Ã¸kta midlertidig
  club.sessions.splice(selectedSessionIndex, 1);

  localStorage.setItem(STORAGE, JSON.stringify(state));

  // ğŸ”’ Hugs open kÃ¸lle
  openClubId = selectedSessionClub;

  closeSessionActions();
  render();

  // ğŸ”“ Gjenopne kÃ¸lla
  const content = document.getElementById("content-"+openClubId);
  const icon = document.getElementById("icon-"+openClubId);
  if(content && icon){
    content.style.display = "block";
    icon.textContent = "â–¼";
  }
}

function confirmDeleteSession(){
  if(selectedSessionClub == null) return;

  if(!confirm("Er du sikker pÃ¥ at du vil slette denne Ã¸kta?")){
    return;
  }

  state[selectedSessionClub].sessions.splice(selectedSessionIndex, 1);
  localStorage.setItem(STORAGE, JSON.stringify(state));

  // ğŸ”’ Hugs open kÃ¸lle
  openClubId = selectedSessionClub;

  closeSessionActions();
  render();

  // ğŸ”“ Gjenopne kÃ¸lla
  const content = document.getElementById("content-"+openClubId);
  const icon = document.getElementById("icon-"+openClubId);
  if(content && icon){
    content.style.display = "block";
    icon.textContent = "â–¼";
  }
}

function resetAllData(){
  if(!confirm("Dette vil slette alle baseline og Ã¸kter. Er du sikker?")){
    return;
  }

  active.forEach(c=>{
    if(!state[c]) return;
    state[c].baseline = null;
    state[c].sessions = [];
    state[c].current = {};
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));

  render();
  renderBagFocus();

  alert("All treningsdata er nullstilt.");
}

</script>

<!-- Ã˜KT-HANDLINGAR -->
<div class="overlay" id="sessionActionsModal">
  <div class="modal">
    <h3 id="sessionActionsTitle">Ã˜kt</h3>

    <div style="margin-top:12px;">
      <button onclick="confirmEditSession()">âœï¸ Rediger Ã¸kt</button>
      <button onclick="confirmDeleteSession()">ğŸ—‘ Slett Ã¸kt</button>
    </div>

    <div style="margin-top:12px;">
      <button onclick="closeSessionActions()">Lukk</button>
    </div>
  </div>
</div>

<!-- Ã˜KTER MODAL -->
<div class="overlay" id="sessionsModal">
  <div class="modal">
    <h3 id="sessionsTitle">ğŸ“š Ã˜kter</h3>
    <div id="sessionsList"></div>
    <button onclick="closeSessions()">Lukk</button>
  </div>
</div>

<!-- FORKLARINGSMODAL -->
<div class="overlay" id="explanationModal">
  <div class="modal">
    <h3>â„¹ï¸ Slik vurderer vi treningsdata</h3>

    <p class="small">
      Denne analysen er basert pÃ¥ etablerte referansenivÃ¥ frÃ¥ golfdata
      (TrackMan / PGA-studiar), tilpassa amatÃ¸rspelarar.
    </p>

    <hr>

    <p><strong>ğŸ“ Side-consistency</strong></p>
    <p class="small">
      MÃ¥ler kor mykje ballen sprer seg side-til-side.
      LÃ¥gare tal = betre presisjon.
    </p>

    <p><strong>ğŸ“ Length consistency</strong></p>
    <p class="small">
      MÃ¥ler variasjon i lengde pÃ¥ like slag.
      LÃ¥gare tal = meir forutsigbar lengde.
    </p>

    <p><strong>âš¡ Smash factor</strong></p>
    <p class="small">
      Forholdet mellom kÃ¸llefart og ballfart.
      HÃ¸gare tal = betre treffkvalitet.
    </p>

    <hr>

    <p class="small">
      <strong>ReferansenivÃ¥:</strong><br>
      â€¢ LÃ¥gare er betre for presisjon og lengdekontroll<br>
      â€¢ HÃ¸gare er betre for smash factor
    </p>

    <button onclick="closeExplanation()">Lukk</button>
  </div>
</div>

<div class="overlay" id="reportModal">
  <div class="modal" style="max-width:800px; max-height:90vh; overflow:auto;">

    <div id="reportContent" class="report-root"></div>

    <div style="margin-top:12px;">
      <button onclick="closeReportPreview()">Lukk</button>
      <button onclick="printReport()">ğŸ“„ Lag PDF</button>
    </div>
  </div>
</div>

<!-- RAPPORTVAL -->
<div class="overlay" id="reportClubModal">
  <div class="modal">
    <h3>ğŸ“„ Vel kÃ¸ller til rapport</h3>

    <div id="reportClubList" class="small"></div>

    <div style="margin-top:12px;">
      <button onclick="confirmReportClubs()">Generer rapport</button>
      <button onclick="closeReportClubModal()">Avbryt</button>
    </div>
  </div>
</div>

</body>
</html>
