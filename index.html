<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Golf ROI â€“ Treningsanalyse</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:16px;
  max-width:1000px;
  margin:auto;
}
h1 { margin-top:10px; }

.card {
  background:white;
  padding:14px;
  margin-bottom:14px;
  border-radius:8px;
}

button {
  padding:6px 10px;
  margin:4px 4px 0 0;
  cursor:pointer;
}

.accordion-header {
  font-weight:bold;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.accordion-content {
  display:none;
  margin-top:12px;
}

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
  gap:12px;
}
.field label { font-size:13px; }
.field .hint { font-size:12px; color:#777; }

input[type=number], select {
  width:100%;
  padding:6px;
}

.good { color:green; }
.bad { color:#c62828; }
.focus { color:#ef6c00; font-weight:bold; }

.tip {
  background:#f1f8e9;
  padding:10px;
  border-radius:6px;
  margin-top:8px;
}

.small { font-size:13px; color:#555; }

.diff-up { color:green; }
.diff-down { color:#c62828; }

.save-msg {
  color:green;
  font-size:13px;
  margin-top:6px;
}

/* MODALS */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal {
  background:white;
  padding:20px;
  border-radius:8px;
  max-width:520px;
  width:100%;
}
</style>
</head>

<body>

<h1>ğŸŒï¸ Golf ROI â€“ Treningsanalyse</h1>

<div class="card">
  <button onclick="openOnboarding()">ğŸš€ Kom i gang</button>
  <button onclick="openProfile()">âš™ï¸ Profil</button>
  <button onclick="openClubs()">ğŸŒï¸ KÃ¸ller</button>
</div>

<!-- ğŸŸ¢ Samla fokus basert pÃ¥ baseline -->
<div id="bagFocusCard" class="card" style="display:none;"></div>

<!-- Analyse per kÃ¸lle -->
<div id="clubs"></div>

<!-- ONBOARDING -->
<div class="overlay" id="onboarding">
  <div class="modal">
    <h3>ğŸš€ Kom i gang</h3>
    <ol>
      <li>Vel kÃ¸llene du brukar</li>
      <li>Legg inn gjennomsnittsdata</li>
      <li>Lagre baseline</li>
      <li>FÃ¸lg utvikling over tid</li>
    </ol>
    <button onclick="closeOnboarding()">Lukk</button>
  </div>
</div>

<!-- PROFIL -->
<div class="overlay" id="profile">
  <div class="modal">
    <h3>âš™ï¸ Profil</h3>

    <label>Handicap-nivÃ¥</label>
    <select id="hcp">
      <option>0â€“8</option>
      <option>9â€“15</option>
      <option>16â€“29</option>
      <option>30â€“54</option>
    </select>

    <label>PrimÃ¦rt treningsfokus</label>
    <select id="preference">
      <option>Presisjon</option>
      <option>Lengde</option>
      <option>Balanse</option>
    </select>

    <br><br>
    <button onclick="saveProfile()">ğŸ’¾ Lagre profil</button>
    <button onclick="closeProfile()">Lukk</button>
  </div>
</div>

<!-- KÃ˜LLEVAL -->
<div class="overlay" id="clubsModal">
  <div class="modal">
    <h3>ğŸŒï¸ Vel kÃ¸ller</h3>
    <div id="clubCheckboxes"></div>
    <button onclick="saveClubs()">ğŸ’¾ Lagre</button>
    <button onclick="closeClubs()">Lukk</button>
  </div>
</div>

<script>
/* ===================== KONFIG ===================== */

const STORAGE = "roi_state_v1_1";
const PROFILE = "roi_profile_v1_1";
const ACTIVE  = "roi_active_clubs_v1_1";

const ALL_CLUBS = [
  "Driver","3W","5W","7W",
  "3i","4i","5i","6i","7i","8i","9i",
  "PW","50Â°","56Â°","60Â°"
];

const PGA = {
  wood:{ side:12, cons:12, smash:1.45 },
  iron:{ side:9, cons:8, smash:1.32 },
  wedge:{ side:7, cons:6, smash:1.22 }
};

/* ===================== COACHING-TEKSTAR (LÃ…ST) ===================== */

const COACHING_TEXT = {

  Presisjon: {
    title: "Presisjon",
    short: "Startretning og sidekontroll er hovudutfordringa no.",
    long: `
Du taper slag fordi ballen startar for langt til hÃ¸gre eller venstre.

ğŸ¯ MÃ¥l:
- Redusere side-consistency
- FÃ¥ fleire slag som startar nÃ¦r mÃ¥l-linja

ğŸ” SjÃ¥ etter:
- Treffpunkt midt i slagflata
- Stabil oppstilling og sikte
- Lik startretning frÃ¥ slag til slag
`
  },

  Lengdekontroll: {
    title: "Lengdekontroll",
    short: "Variasjon i lengde gjer kÃ¸lleval og innspel vanskeleg.",
    long: `
Du slÃ¥r bÃ¥de for korte og for lange slag med same kÃ¸lle.

ğŸ¯ MÃ¥l:
- Smalare lengdespredning
- Meir forutsigbar carry

ğŸ” SjÃ¥ etter:
- Stabilt tempo
- Lik ballposisjon
- Treff i same hÃ¸gde pÃ¥ slagflata
`
  },

  Treffkvalitet: {
    title: "Treffkvalitet",
    short: "Smash factor indikerer ustabil ballkontakt.",
    long: `
Du mistar fart og kontroll fordi du ikkje treff ballen reint nok.

ğŸ¯ MÃ¥l:
- Auke smash factor
- Treff oftare nÃ¦r senter av slagflata

ğŸ” SjÃ¥ etter:
- Kontaktpunkt (bruk gjerne spray/tape)
- Rolig overgang i nedsving
- Balanse gjennom treff
`
  },

  Vedlikehald: {
    title: "Vedlikehald",
    short: "Dette fungerer bra â€“ hald ved like gode vanar.",
    long: `
Dataene viser at dette omrÃ¥det fungerer godt no.

ğŸ¯ MÃ¥l:
- Behalde nivÃ¥et
- UnngÃ¥ regresjon

ğŸ” SjÃ¥ etter:
- Same rutinar
- Samme fokus som tidlegare
- UnngÃ¥ Ã¥ endre for mykje
`
  }

};

function clubType(c){
  if(c==="Driver"||c.includes("W")) return "wood";
  if(c.endsWith("i")) return "iron";
  return "wedge";
}

function drillLink(f){
  if(f==="Presisjon") return "ovelser/startretning.html";
  if(f==="Lengdekontroll") return "ovelser/lengdekontroll.html";
  if(f==="Treff") return "ovelser/treffkvalitet.html";
  if(f==="Vedlikehald") return "ovelser/vedlikehald.html";
  return "ovelser/driver-kontroll.html";
}

/* ===================== STATE ===================== */

let state = JSON.parse(localStorage.getItem(STORAGE)) || {};
let active = JSON.parse(localStorage.getItem(ACTIVE)) || [];

/* ===================== TREND HELPERS ===================== */

function trend(current, reference, higherIsBetter){
  const diff = current - reference;
  const good = higherIsBetter ? diff >= 0 : diff <= 0;
  const arrow = diff > 0 ? "â†‘" : diff < 0 ? "â†“" : "â†’";
  const cls = good ? "diff-up" : "diff-down";
  return `<span class="${cls}">${arrow} ${Math.abs(diff).toFixed(2)}</span>`;
}

/* =====================
   v2.2 â€“ STEG 4: UI-RENDER
===================== */

function renderBagFocus(){
  const card = document.getElementById("bagFocusCard");
  if(!card) return;

  const result = getBagFocus();

  // Fallback: ikkje nok data
  if(!result || result.clubsCount < 3){
    card.style.display = "none";
    return;
  }

  const focus = result.focus;
  const text = COACHING_TEXT[focus];

  if(!text){
    card.style.display = "none";
    return;
  }

  card.innerHTML = `
    <h3>ğŸ¯ Fokus for neste treningsbolk</h3>
    <p><strong>${text.title}</strong></p>
    <p class="small">${text.short}</p>
    <pre class="small">${text.long}</pre>
    <p class="small">
      Basert pÃ¥ ${result.clubsCount} kÃ¸ller med baseline.
    </p>
  `;

  card.style.display = "block";
}

/* ===================== RENDER ===================== */

const wrap = document.getElementById("clubs");

function render(){
  wrap.innerHTML = "";

  if(active.length === 0){
    wrap.innerHTML = `
      <div class="card small">
        Ingen kÃ¸ller vald. Trykk pÃ¥ <strong>ğŸŒï¸ KÃ¸ller</strong> for Ã¥ velje.
      </div>`;
    return;
  }

  active.forEach(c=>{
    state[c] ||= { current:{}, baseline:null, previous:null };

    wrap.innerHTML += `
      <div class="card">
        <div class="accordion-header" onclick="toggle('${c}')">
          ${c}<span id="icon-${c}">â–¶</span>
        </div>
        <div class="accordion-content" id="content-${c}">
          <div class="grid">
            ${field(c,"side","Side-consistency (m)","Side-til-side utslag")}
            ${field(c,"cons","Length consistency (m)","Lengdespredning")}
            ${field(c,"smash","Smash factor","Treffkvalitet",0.01)}
          </div>
          ${baselineButtons(c)}
          <div id="eval-${c}"></div>
          <div id="save-msg-${c}"></div>
        </div>
      </div>`;
    evaluate(c);
  });

  localStorage.setItem(STORAGE, JSON.stringify(state));
}

function field(c,k,l,h,s=1){
  const v = state[c].current[k] ?? "";
  return `
    <div class="field">
      <label>${l}</label>
      <div class="hint">${h}</div>
      <input type="number" step="${s}" value="${v}"
        oninput="update('${c}','${k}',this.value)">
    </div>`;
}

function update(c,k,v){
  state[c].current[k] = v ? parseFloat(v) : undefined;
  localStorage.setItem(STORAGE, JSON.stringify(state));
  evaluate(c);
}

function baselineButtons(c){
  const hasBaseline = state[c].baseline && Object.keys(state[c].baseline).length > 0;

  if(!hasBaseline){
    return `<button onclick="setBaseline('${c}')">ğŸ“Œ Lagre baseline</button>`;
  }

  return `
    <p class="small">Baseline lagra âœ…</p>
    <button onclick="saveSession('${c}')">ğŸ’¾ Lagre Ã¸kt</button>
    <button onclick="editBaseline('${c}')">âœï¸ Rediger baseline</button>
  `;
}

function setBaseline(c){
  state[c].baseline = {...state[c].current};
  localStorage.setItem(STORAGE, JSON.stringify(state));
  showSaveMsg(c,"âœ“ Baseline lagra");
  evaluate(c);
  renderBagFocus();
}

function saveSession(c){
  state[c].previous = {...state[c].current};
  localStorage.setItem(STORAGE, JSON.stringify(state));
  showSaveMsg(c,"âœ“ Ã˜kt lagra");
}

function editBaseline(c){
  if(confirm("Slette baseline?")){
    state[c].baseline = null;
    localStorage.setItem(STORAGE, JSON.stringify(state));
    render();
  }
}

function showSaveMsg(c,text){
  const el = document.getElementById("save-msg-"+c);
  el.innerText = text;
  setTimeout(()=>el.innerText="",4000);
}

function toggle(c){
  const e=document.getElementById("content-"+c);
  const i=document.getElementById("icon-"+c);
  e.style.display=e.style.display==="block"?"none":"block";
  i.textContent=e.style.display==="block"?"â–¼":"â–¶";
}

/* ===================== ANALYSE ===================== */

function evaluate(c){
  const v = state[c].current;
  const b = state[c].baseline;
  const p = PGA[clubType(c)];
  let good=[], bad=[], focus="Vedlikehald";

  if(v.side!=null){
    v.side<=p.side ? good.push("God sidekontroll") : bad.push("For stort sideutslag");
  }
  if(v.cons!=null){
    v.cons<=p.cons ? good.push("Stabil lengde") : bad.push("Ustabil lengde");
  }
  if(v.smash!=null){
    v.smash>=p.smash ? good.push("Reint treff") : bad.push("Ureint treff");
  }

  if(bad.includes("For stort sideutslag")) focus="Presisjon";
  else if(bad.includes("Ustabil lengde")) focus="Lengdekontroll";
  else if(bad.includes("Ureint treff")) focus="Treff";

  let trends = "";
  if(b){
    trends += `
      <strong>Trend mot baseline:</strong><br>
      Side: ${trend(v.side,b.side,false)}<br>
      Lengde: ${trend(v.cons,b.cons,false)}<br>
      Smash: ${trend(v.smash,b.smash,true)}<br>`;
  }
  if(state[c].previous){
    const p0 = state[c].previous;
    trends += `
      <br><strong>Sidan fÃ¸rre Ã¸kt:</strong><br>
      Side: ${trend(v.side,p0.side,false)}<br>
      Lengde: ${trend(v.cons,p0.cons,false)}<br>
      Smash: ${trend(v.smash,p0.smash,true)}<br>`;
  }

  document.getElementById("eval-"+c).innerHTML = `
    <p class="good"><strong>Bra:</strong> ${good.join(", ")||"â€”"}</p>
    <p class="bad"><strong>DÃ¥rleg:</strong> ${bad.join(", ")||"â€”"}</p>
    <p class="focus">ğŸ¯ Fokus: ${focus}</p>
    ${trends ? `<div class="small">${trends}</div>` : ""}
    <div class="tip">
      <strong>ğŸ›  Treningsforslag:</strong><br>
      <a href="${drillLink(focus)}" target="_blank">ğŸ‘‰ Opne Ã¸ving</a>
    </div>`;
}

/* ===================== MODALS ===================== */

function openOnboarding(){document.getElementById("onboarding").style.display="flex";}
function closeOnboarding(){document.getElementById("onboarding").style.display="none";}
function openProfile(){document.getElementById("profile").style.display="flex";}
function closeProfile(){document.getElementById("profile").style.display="none";}
function openClubs(){
  document.getElementById("clubsModal").style.display="flex";
  const c=document.getElementById("clubCheckboxes");
  c.innerHTML="";
  ALL_CLUBS.forEach(k=>{
    c.innerHTML+=`
      <label>
        <input type="checkbox" ${active.includes(k)?"checked":""}
        onchange="toggleClub('${k}')"> ${k}
      </label>`;
  });
}
function closeClubs(){document.getElementById("clubsModal").style.display="none";}

function toggleClub(k){
  active = active.includes(k)
    ? active.filter(x => x !== k)
    : [...active, k];
}

function saveClubs(){
  localStorage.setItem(ACTIVE, JSON.stringify(active));
  closeClubs();
  render();
}

function saveProfile(){
  localStorage.setItem(PROFILE, JSON.stringify({
    hcp:document.getElementById("hcp").value,
    preference:document.getElementById("preference").value
  }));
  closeProfile();
}

/* INIT */
render();
renderBagFocus();

// =====================
// v2.2 â€“ STEG 1 (SAFE)
// =====================

function getActiveClubsSafe(){
  try {
    const stored = JSON.parse(localStorage.getItem(ACTIVE));
    return Array.isArray(stored) ? stored : [];
  } catch(e){
    return [];
  }
}

function getClubsWithBaseline(){
  const active = getActiveClubsSafe();
  if(!Array.isArray(active)) return [];

  return active.filter(id =>
    state &&
    state[id] &&
    state[id].baseline
  );
}

function getClubFocus(clubId){
  if(!state || !state[clubId] || !state[clubId].current) return null;

  const v = state[clubId].current;
  const p = PGA[clubType(clubId)];
  if(!p) return null;

  if(v.side != null && v.side > p.side) return "Presisjon";
  if(v.cons != null && v.cons > p.cons) return "Lengdekontroll";
  if(v.smash != null && v.smash < p.smash) return "Treffkvalitet";

  return "Vedlikehald";
}
/* ==========================================
   v2.2 â€“ STEG 2: AGGREGERT BAG-FOKUS
========================================== */

function getBagFocus(){
  const clubs = getClubsWithBaseline();
  if(!clubs.length) return null;

  const counts = {};

  clubs.forEach(clubId => {
    const focus = getClubFocus(clubId);
    if(!focus) return;
    counts[focus] = (counts[focus] || 0) + 1;
  });

  let topFocus = null;
  let maxCount = 0;

  for(const f in counts){
    if(counts[f] > maxCount){
      maxCount = counts[f];
      topFocus = f;
    }
  }

  return {
    focus: topFocus,
    breakdown: counts,
    clubsCount: clubs.length
  };
}
</script>

</body>
</html>
